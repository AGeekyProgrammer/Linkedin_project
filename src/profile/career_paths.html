<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Path Explorer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }
        .header {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(10px);
            padding: 25px 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(90deg, #00d9ff, #00ff88, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header p { color: #888; margin-top: 8px; font-size: 14px; }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 25px 40px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            align-items: center;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .control-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
        }
        select, input[type="range"] {
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            color: #e8e8e8;
            font-size: 14px;
            cursor: pointer;
            min-width: 200px;
        }
        select:hover, input:hover {
            border-color: #00d9ff;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #00d9ff;
            box-shadow: 0 0 0 3px rgba(0,217,255,0.2);
        }

        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 20px 40px;
            background: rgba(0,0,0,0.2);
        }
        .category-tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .category-tab:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }
        .category-tab.active {
            background: linear-gradient(135deg, rgba(0,217,255,0.3), rgba(0,255,136,0.2));
            border-color: #00d9ff;
            color: #00d9ff;
        }
        .category-tab .count {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: calc(100vh - 250px);
        }

        .sidebar {
            background: rgba(0,0,0,0.2);
            border-right: 1px solid rgba(255,255,255,0.05);
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 250px);
        }
        .sidebar h3 {
            font-size: 14px;
            color: #00d9ff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .profile-mini {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        .profile-mini:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(0,217,255,0.3);
        }
        .profile-mini.selected {
            background: rgba(0,217,255,0.1);
            border-color: #00d9ff;
        }
        .profile-mini h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .profile-mini .headline {
            font-size: 11px;
            color: #888;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .profile-mini .metrics {
            display: flex;
            gap: 15px;
            font-size: 11px;
        }
        .profile-mini .metric {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .profile-mini .metric-value {
            color: #00ff88;
            font-weight: 600;
        }

        .visualization {
            padding: 30px;
            overflow-y: auto;
        }

        .career-path-container {
            background: rgba(255,255,255,0.02);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 25px;
        }
        .career-path-container h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #fff;
        }
        .career-path-container .subtitle {
            font-size: 13px;
            color: #888;
            margin-bottom: 25px;
        }

        .career-timeline {
            position: relative;
            padding-left: 30px;
        }
        .career-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #00d9ff, #00ff88, #ff6b6b);
            border-radius: 2px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            padding-left: 25px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 5px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #0f0f1a;
            border: 3px solid #00d9ff;
        }
        .timeline-item.current::before {
            background: #00ff88;
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0,255,136,0.5);
        }
        .timeline-item .position {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }
        .timeline-item .company {
            font-size: 13px;
            color: #00d9ff;
            margin-bottom: 4px;
        }
        .timeline-item .duration {
            font-size: 12px;
            color: #666;
        }
        .timeline-item .description {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
            line-height: 1.5;
            display: none;
        }
        .timeline-item.expanded .description {
            display: block;
        }

        .sankey-container {
            width: 100%;
            height: 500px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            margin-top: 20px;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: rgba(255,255,255,0.03);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-card .label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .no-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #666;
            text-align: center;
        }
        .no-selection svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #888;
        }
        .loading::after {
            content: '';
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0,217,255,0.2);
            border-top-color: #00d9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .range-display {
            font-size: 12px;
            color: #00d9ff;
            min-width: 80px;
            text-align: right;
        }

        .range-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 200px;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            padding: 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #00d9ff;
            border-radius: 50%;
            cursor: pointer;
        }

        .aggregate-view {
            display: none;
        }
        .aggregate-view.active {
            display: block;
        }

        .flow-path {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .flow-path .path-roles {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .flow-path .role-node {
            background: linear-gradient(135deg, rgba(0,217,255,0.2), rgba(0,255,136,0.1));
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
        }
        .flow-path .arrow {
            color: #00ff88;
            font-size: 16px;
        }
        .flow-path .path-count {
            font-size: 11px;
            color: #888;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .sidebar {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Career Path Explorer</h1>
        <p>Explore how professionals reached their current positions. Filter by category and engagement metrics.</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <span class="control-label">Sort By</span>
            <select id="sortBy">
                <option value="followers">Followers (High to Low)</option>
                <option value="followers_asc">Followers (Low to High)</option>
                <option value="connections">Connections (High to Low)</option>
                <option value="connections_asc">Connections (Low to High)</option>
                <option value="experience">Experience Count</option>
            </select>
        </div>
        <div class="control-group">
            <span class="control-label">Min Followers</span>
            <div class="range-wrapper">
                <input type="range" id="minFollowers" min="0" max="100000" value="0" step="100">
                <span class="range-display" id="minFollowersDisplay">0</span>
            </div>
        </div>
        <div class="control-group">
            <span class="control-label">Min Connections</span>
            <div class="range-wrapper">
                <input type="range" id="minConnections" min="0" max="30000" value="0" step="100">
                <span class="range-display" id="minConnectionsDisplay">0</span>
            </div>
        </div>
        <div class="control-group">
            <span class="control-label">View Mode</span>
            <select id="viewMode">
                <option value="individual">Individual Paths</option>
                <option value="aggregate">Aggregate Flow</option>
            </select>
        </div>
    </div>

    <div class="category-tabs" id="categoryTabs">
        <div class="loading">Loading categories...</div>
    </div>

    <div class="main-content">
        <div class="sidebar">
            <h3>Profiles <span id="profileCount">(0)</span></h3>
            <div id="profileList">
                <div class="loading">Loading profiles...</div>
            </div>
        </div>

        <div class="visualization">
            <div class="stats-summary" id="statsSummary"></div>

            <div id="individualView">
                <div class="no-selection" id="noSelection">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 4.5v15m7.5-7.5h-15"/>
                    </svg>
                    <p>Select a profile from the sidebar to view their career path</p>
                </div>
                <div id="careerPathDisplay"></div>
            </div>

            <div class="aggregate-view" id="aggregateView">
                <div class="career-path-container">
                    <h3>Common Career Transitions</h3>
                    <p class="subtitle">Most frequent role progressions in this category</p>
                    <div id="aggregatePaths"></div>
                </div>
                <div class="career-path-container">
                    <h3>Career Flow Visualization</h3>
                    <p class="subtitle">Visual representation of career progressions</p>
                    <div class="sankey-container" id="sankeyChart"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Global data store
    let allProfiles = [];
    let filteredProfiles = [];
    let selectedCategory = 'all';
    let selectedProfile = null;

    // Category definitions based on keywords in headlines/positions
    const categories = {
        'all': { name: 'All Profiles', keywords: [] },
        'ai-ml': { name: 'AI & Machine Learning', keywords: ['ai', 'artificial intelligence', 'machine learning', 'ml', 'deep learning', 'llm', 'gpt', 'data science'] },
        'product': { name: 'Product Management', keywords: ['product manager', 'product lead', 'head of product', 'director of product', 'vp product', 'cpo'] },
        'engineering': { name: 'Engineering', keywords: ['software engineer', 'developer', 'engineering manager', 'cto', 'tech lead', 'architect', 'full stack', 'backend', 'frontend'] },
        'leadership': { name: 'Executive/Leadership', keywords: ['ceo', 'coo', 'cfo', 'founder', 'co-founder', 'managing director', 'president', 'partner', 'chief'] },
        'education': { name: 'Education', keywords: ['teacher', 'professor', 'educator', 'instructor', 'academic', 'school', 'university', 'education'] },
        'consulting': { name: 'Consulting', keywords: ['consultant', 'advisor', 'consulting', 'strategy', 'strategist'] },
        'marketing': { name: 'Marketing & Growth', keywords: ['marketing', 'growth', 'brand', 'content', 'seo', 'digital marketing', 'cmo'] },
        'sales': { name: 'Sales & BD', keywords: ['sales', 'business development', 'account executive', 'revenue', 'partnerships'] }
    };

    // Load data from JSON file
    async function loadData() {
        try {
            const response = await fetch('df_cleaned.json');
            if (!response.ok) {
                throw new Error(`HTTP error: ${response.status} ${response.statusText}`);
            }
            const text = await response.text();

            if (!text || text.trim().length === 0) {
                throw new Error('Empty response from server');
            }

            const lines = text.trim().split('\n');
            let parseErrors = 0;

            allProfiles = lines.map((line, index) => {
                try {
                    const profile = JSON.parse(line);
                    profile._id = index;
                    return profile;
                } catch (e) {
                    parseErrors++;
                    console.warn(`Failed to parse line ${index + 1}:`, e.message);
                    return null;
                }
            }).filter(p => p !== null);

            if (allProfiles.length === 0) {
                throw new Error(`No valid profiles found. Parse errors: ${parseErrors}`);
            }

            console.log('Loaded profiles:', allProfiles.length);
            if (parseErrors > 0) {
                console.warn(`Skipped ${parseErrors} invalid lines`);
            }
            initializeUI();
        } catch (error) {
            console.error('Error loading data:', error);
            const errorMsg = error.message.includes('Failed to fetch')
                ? 'Failed to load data. If opening this file directly, please use a local web server (e.g., python3 -m http.server).'
                : `Error loading data: ${error.message}`;
            document.getElementById('profileList').innerHTML = `<p style="color: #ff6b6b; padding: 10px;">${errorMsg}</p>`;
            document.getElementById('categoryTabs').innerHTML = `<p style="color: #ff6b6b; padding: 20px;">${errorMsg}</p>`;
        }
    }

    // Categorize a profile based on keywords
    function categorizeProfile(profile) {
        const text = [
            profile.headline || '',
            ...(profile.experience || []).map(e => e.position || '').slice(0, 3)
        ].join(' ').toLowerCase();

        const matches = [];
        for (const [key, cat] of Object.entries(categories)) {
            if (key === 'all') continue;
            if (cat.keywords.some(kw => text.includes(kw))) {
                matches.push(key);
            }
        }
        return matches.length > 0 ? matches : ['other'];
    }

    // Initialize the UI
    function initializeUI() {
        // Count profiles per category
        const categoryCounts = { 'all': allProfiles.length };
        allProfiles.forEach(p => {
            const cats = categorizeProfile(p);
            cats.forEach(c => {
                categoryCounts[c] = (categoryCounts[c] || 0) + 1;
            });
        });

        // Render category tabs
        const tabsHtml = Object.entries(categories).map(([key, cat]) => {
            const count = categoryCounts[key] || 0;
            if (count === 0 && key !== 'all') return '';
            return `
                <div class="category-tab ${key === 'all' ? 'active' : ''}" data-category="${key}">
                    ${cat.name}
                    <span class="count">${count}</span>
                </div>
            `;
        }).join('');

        // Add "Other" category
        const otherCount = categoryCounts['other'] || 0;
        const otherHtml = otherCount > 0 ? `
            <div class="category-tab" data-category="other">
                Other
                <span class="count">${otherCount}</span>
            </div>
        ` : '';

        document.getElementById('categoryTabs').innerHTML = tabsHtml + otherHtml;

        // Add click handlers
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                selectedCategory = tab.dataset.category;
                selectedProfile = null;
                filterAndRenderProfiles();
            });
        });

        // Set up controls
        document.getElementById('sortBy').addEventListener('change', filterAndRenderProfiles);
        document.getElementById('minFollowers').addEventListener('input', (e) => {
            document.getElementById('minFollowersDisplay').textContent = formatNumber(e.target.value);
            filterAndRenderProfiles();
        });
        document.getElementById('minConnections').addEventListener('input', (e) => {
            document.getElementById('minConnectionsDisplay').textContent = formatNumber(e.target.value);
            filterAndRenderProfiles();
        });
        document.getElementById('viewMode').addEventListener('change', (e) => {
            const isAggregate = e.target.value === 'aggregate';
            document.getElementById('individualView').style.display = isAggregate ? 'none' : 'block';
            document.getElementById('aggregateView').classList.toggle('active', isAggregate);
            if (isAggregate) {
                renderAggregateView();
            }
        });

        filterAndRenderProfiles();
    }

    // Filter and render profiles
    function filterAndRenderProfiles() {
        const minFollowers = parseInt(document.getElementById('minFollowers').value) || 0;
        const minConnections = parseInt(document.getElementById('minConnections').value) || 0;
        const sortBy = document.getElementById('sortBy').value;

        // Filter by category
        filteredProfiles = allProfiles.filter(p => {
            if (selectedCategory === 'all') return true;
            const cats = categorizeProfile(p);
            return cats.includes(selectedCategory);
        });

        // Filter by metrics
        filteredProfiles = filteredProfiles.filter(p => {
            const followers = p.followerCount || 0;
            const connections = p.connectionsCount || 0;
            return followers >= minFollowers && connections >= minConnections;
        });

        // Sort
        filteredProfiles.sort((a, b) => {
            switch (sortBy) {
                case 'followers':
                    return (b.followerCount || 0) - (a.followerCount || 0);
                case 'followers_asc':
                    return (a.followerCount || 0) - (b.followerCount || 0);
                case 'connections':
                    return (b.connectionsCount || 0) - (a.connectionsCount || 0);
                case 'connections_asc':
                    return (a.connectionsCount || 0) - (b.connectionsCount || 0);
                case 'experience':
                    return (b.experience?.length || 0) - (a.experience?.length || 0);
                default:
                    return 0;
            }
        });

        renderProfileList();
        renderStats();

        if (document.getElementById('viewMode').value === 'aggregate') {
            renderAggregateView();
        }
    }

    // Render profile list in sidebar
    function renderProfileList() {
        const container = document.getElementById('profileList');
        document.getElementById('profileCount').textContent = `(${filteredProfiles.length})`;

        if (filteredProfiles.length === 0) {
            container.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No profiles match the current filters</p>';
            return;
        }

        container.innerHTML = filteredProfiles.map(p => {
            const name = extractName(p);
            return `
                <div class="profile-mini" data-id="${p._id}">
                    <h4>${name}</h4>
                    <div class="headline">${p.headline || 'No headline'}</div>
                    <div class="metrics">
                        <div class="metric">
                            <span>Followers:</span>
                            <span class="metric-value">${formatNumber(p.followerCount || 0)}</span>
                        </div>
                        <div class="metric">
                            <span>Connections:</span>
                            <span class="metric-value">${formatNumber(p.connectionsCount || 0)}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Add click handlers
        container.querySelectorAll('.profile-mini').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('.profile-mini').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                const id = parseInt(el.dataset.id);
                selectedProfile = allProfiles.find(p => p._id === id);
                renderCareerPath(selectedProfile);
            });
        });
    }

    // Render stats summary
    function renderStats() {
        const totalFollowers = filteredProfiles.reduce((sum, p) => sum + (p.followerCount || 0), 0);
        const totalConnections = filteredProfiles.reduce((sum, p) => sum + (p.connectionsCount || 0), 0);
        const avgExperience = filteredProfiles.length > 0
            ? Math.round(filteredProfiles.reduce((sum, p) => sum + (p.experience?.length || 0), 0) / filteredProfiles.length)
            : 0;

        document.getElementById('statsSummary').innerHTML = `
            <div class="stat-card">
                <div class="value">${filteredProfiles.length}</div>
                <div class="label">Profiles</div>
            </div>
            <div class="stat-card">
                <div class="value">${formatNumber(totalFollowers)}</div>
                <div class="label">Total Followers</div>
            </div>
            <div class="stat-card">
                <div class="value">${formatNumber(totalConnections)}</div>
                <div class="label">Total Connections</div>
            </div>
            <div class="stat-card">
                <div class="value">${avgExperience}</div>
                <div class="label">Avg Positions</div>
            </div>
        `;
    }

    // Render career path for selected profile
    function renderCareerPath(profile) {
        if (!profile) return;

        document.getElementById('noSelection').style.display = 'none';
        const container = document.getElementById('careerPathDisplay');

        const experience = profile.experience || [];
        const name = extractName(profile);

        // Reverse to show oldest first (career progression)
        const sortedExperience = [...experience].reverse();

        const nameLink = profile.linkedinUrl
            ? `<a href="${profile.linkedinUrl}" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none; border-bottom: 2px solid #00d9ff;">${name}</a>`
            : name;

        container.innerHTML = `
            <div class="career-path-container">
                <h3>${nameLink}'s Career Journey</h3>
                <p class="subtitle">
                    ${formatNumber(profile.followerCount || 0)} followers ·
                    ${formatNumber(profile.connectionsCount || 0)} connections ·
                    ${experience.length} positions
                </p>

                <div class="career-timeline">
                    ${sortedExperience.map((exp, i) => {
                        const isCurrent = i === sortedExperience.length - 1 && !exp.endDate?.text?.includes('20');
                        return `
                            <div class="timeline-item ${isCurrent ? 'current' : ''}" onclick="this.classList.toggle('expanded')">
                                <div class="position">${exp.position || 'Unknown Position'}</div>
                                <div class="company">${exp.companyName || 'Unknown Company'}</div>
                                <div class="duration">
                                    ${exp.startDate?.text || '?'} - ${exp.endDate?.text || 'Present'}
                                    ${exp.duration ? ` · ${exp.duration}` : ''}
                                </div>
                                ${exp.description ? `<div class="description">${exp.description.substring(0, 300)}${exp.description.length > 300 ? '...' : ''}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    // Render aggregate view with common paths
    function renderAggregateView() {
        const pathCounts = {};

        filteredProfiles.forEach(profile => {
            const experience = profile.experience || [];
            if (experience.length < 2) return;

            // Get simplified role titles
            const roles = experience.slice(0, 5).map(e => simplifyRole(e.position || '')).filter(r => r);

            // Create path from roles (reversed for chronological order)
            for (let i = roles.length - 1; i > 0; i--) {
                const from = roles[i];
                const to = roles[i - 1];
                const key = `${from} -> ${to}`;
                pathCounts[key] = (pathCounts[key] || 0) + 1;
            }
        });

        // Sort by count and get top paths
        const topPaths = Object.entries(pathCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 15);

        document.getElementById('aggregatePaths').innerHTML = topPaths.map(([path, count]) => {
            const [from, to] = path.split(' -> ');
            return `
                <div class="flow-path">
                    <div class="path-roles">
                        <span class="role-node">${from}</span>
                        <span class="arrow">→</span>
                        <span class="role-node">${to}</span>
                    </div>
                    <div class="path-count">${count} professional${count > 1 ? 's' : ''} made this transition</div>
                </div>
            `;
        }).join('') || '<p style="color: #888;">Not enough data for pattern analysis</p>';

        // Render Sankey diagram
        renderSankey(pathCounts);
    }

    // Render Sankey diagram
    function renderSankey(pathCounts) {
        const container = document.getElementById('sankeyChart');
        container.innerHTML = '';

        if (Object.keys(pathCounts).length < 3) {
            container.innerHTML = '<p style="color: #888; text-align: center; padding: 50px;">Not enough transitions to visualize</p>';
            return;
        }

        const width = container.clientWidth;
        const height = 500;

        // Build nodes and links
        const nodeSet = new Set();
        const links = [];

        Object.entries(pathCounts).forEach(([path, count]) => {
            if (count < 1) return;
            const [from, to] = path.split(' -> ');
            nodeSet.add(from);
            nodeSet.add(to);
            links.push({ source: from, target: to, value: count });
        });

        const nodes = Array.from(nodeSet).map(name => ({ name }));
        const nodeIndex = {};
        nodes.forEach((n, i) => nodeIndex[n.name] = i);

        const sankeyLinks = links.map(l => ({
            source: nodeIndex[l.source],
            target: nodeIndex[l.target],
            value: l.value
        })).filter(l => l.source !== undefined && l.target !== undefined);

        if (sankeyLinks.length === 0) {
            container.innerHTML = '<p style="color: #888; text-align: center; padding: 50px;">No valid transitions to display</p>';
            return;
        }

        const svg = d3.select(container)
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        const sankey = d3.sankey()
            .nodeWidth(20)
            .nodePadding(15)
            .extent([[20, 20], [width - 20, height - 20]]);

        const graph = sankey({
            nodes: nodes.map(d => Object.assign({}, d)),
            links: sankeyLinks.map(d => Object.assign({}, d))
        });

        // Draw links
        svg.append('g')
            .selectAll('path')
            .data(graph.links)
            .join('path')
            .attr('d', d3.sankeyLinkHorizontal())
            .attr('fill', 'none')
            .attr('stroke', 'url(#gradient)')
            .attr('stroke-opacity', 0.4)
            .attr('stroke-width', d => Math.max(1, d.width));

        // Add gradient
        const gradient = svg.append('defs')
            .append('linearGradient')
            .attr('id', 'gradient')
            .attr('x1', '0%')
            .attr('x2', '100%');

        gradient.append('stop').attr('offset', '0%').attr('stop-color', '#00d9ff');
        gradient.append('stop').attr('offset', '100%').attr('stop-color', '#00ff88');

        // Draw nodes
        svg.append('g')
            .selectAll('rect')
            .data(graph.nodes)
            .join('rect')
            .attr('x', d => d.x0)
            .attr('y', d => d.y0)
            .attr('height', d => Math.max(1, d.y1 - d.y0))
            .attr('width', d => d.x1 - d.x0)
            .attr('fill', '#00d9ff')
            .attr('rx', 3);

        // Draw labels
        svg.append('g')
            .selectAll('text')
            .data(graph.nodes)
            .join('text')
            .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
            .attr('y', d => (d.y1 + d.y0) / 2)
            .attr('dy', '0.35em')
            .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
            .attr('fill', '#e8e8e8')
            .attr('font-size', '11px')
            .text(d => d.name.length > 25 ? d.name.substring(0, 25) + '...' : d.name);
    }

    // Helper: Extract name from profile
    function extractName(profile) {
        if (profile.linkedinUrl) {
            const match = profile.linkedinUrl.match(/\/in\/([^\/]+)/);
            if (match) {
                return match[1].split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            }
        }
        return 'Unknown';
    }

    // Helper: Simplify role title
    function simplifyRole(title) {
        if (!title) return '';
        const lower = title.toLowerCase();

        // Map to common categories
        if (lower.includes('ceo') || lower.includes('chief executive')) return 'CEO';
        if (lower.includes('cto') || lower.includes('chief technology')) return 'CTO';
        if (lower.includes('cfo') || lower.includes('chief financial')) return 'CFO';
        if (lower.includes('coo') || lower.includes('chief operating')) return 'COO';
        if (lower.includes('founder')) return 'Founder';
        if (lower.includes('co-founder')) return 'Co-Founder';
        if (lower.includes('vp') || lower.includes('vice president')) return 'VP';
        if (lower.includes('director')) return 'Director';
        if (lower.includes('head of')) return 'Head';
        if (lower.includes('manager')) return 'Manager';
        if (lower.includes('senior') && lower.includes('engineer')) return 'Senior Engineer';
        if (lower.includes('engineer')) return 'Engineer';
        if (lower.includes('consultant')) return 'Consultant';
        if (lower.includes('analyst')) return 'Analyst';
        if (lower.includes('teacher') || lower.includes('instructor')) return 'Educator';
        if (lower.includes('professor')) return 'Professor';
        if (lower.includes('intern')) return 'Intern';
        if (lower.includes('associate')) return 'Associate';
        if (lower.includes('specialist')) return 'Specialist';
        if (lower.includes('lead')) return 'Lead';
        if (lower.includes('product')) return 'Product';

        // Return simplified version
        const words = title.split(/[\s,|]+/).slice(0, 3);
        return words.join(' ').substring(0, 30);
    }

    // Helper: Format number
    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    // Initialize
    loadData();
    </script>
</body>
</html>
